name: Deploy to VPS

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/sales-nav-helper:latest
            ghcr.io/${{ github.repository_owner }}/sales-nav-helper:${{ github.sha }}

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin
            DEBUG_VIDEO="${{ secrets.DEBUG_VIDEO }}"
            XVFB="${{ secrets.XVFB }}"
            VNC="${{ secrets.VNC }}"
            FAST_MODE="${{ secrets.FAST_MODE }}"
            SCRAPER_SPEED_SCALE="${{ secrets.SCRAPER_SPEED_SCALE }}"
            docker pull ghcr.io/${{ github.repository_owner }}/sales-nav-helper:${{ github.sha }}
            docker stop sales-nav-helper || true
            docker rm sales-nav-helper || true
            docker run -d \
              --name sales-nav-helper \
              --restart unless-stopped \
              -p 3002:3001 \
              -e PORT=3001 \
              -e BASE_PATH=/salesnav \
              -e CORS_ORIGINS=https://api.daddy-leads.com,https://daddy-leads.com,https://www.daddy-leads.com \
              -e DEBUG_VIDEO=${DEBUG_VIDEO:-false} \
              -e XVFB=${XVFB:-false} \
              -e VNC=${VNC:-false} \
              -e FAST_MODE=${FAST_MODE:-false} \
              -e SCRAPER_SPEED_SCALE=${SCRAPER_SPEED_SCALE:-} \
              -e DISPLAY=:99 \
              --shm-size=1g \
              ghcr.io/${{ github.repository_owner }}/sales-nav-helper:${{ github.sha }}

            # Verify container is actually running (otherwise NGINX will show 502)
            sleep 5
            docker ps --filter "name=sales-nav-helper"
            docker inspect sales-nav-helper --format "image={{.Config.Image}} id={{.Id}}"
            if ! docker ps --format "{{.Names}}" | grep -q "^sales-nav-helper$"; then
              echo "sales-nav-helper is not running; recent logs:" >&2
              docker logs sales-nav-helper --tail 200 || true
              exit 1
            fi

            # Basic smoke test from the VPS host
            curl -fsS -o /dev/null http://127.0.0.1:3002/salesnav/status
